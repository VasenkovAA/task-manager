{% extends 'base.html' %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h3>–ì—Ä–∞—Ñ –∑–∞–¥–∞—á</h3>
        <div class="btn-group">
            <button class="btn btn-sm btn-outline-secondary" id="zoomIn">+</button>
            <button class="btn btn-sm btn-outline-secondary" id="zoomOut">-</button>
            <button class="btn btn-sm btn-outline-primary" id="fit">–ê–≤—Ç–æ—Ä–∞–∑–º–µ—Ä</button>
        </div>
    </div>
    <div class="card-body">
        <div id="diagramDiv" style="width: 100%; height: 600px; background-color: #fafafa; border: 1px solid #ddd;"></div>
    </div>
</div>

<script src="https://unpkg.com/gojs/release/go.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const $ = go.GraphObject.make;
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∏–∞–≥—Ä–∞–º–º—ã —Å TreeLayout
    const diagram = $(go.Diagram, "diagramDiv", {
        initialContentAlignment: go.Spot.Center,
        "undoManager.isEnabled": true,
        layout: $(go.TreeLayout, { 
            
            nodeSpacing: 20,
 
        })
    });

    // –®–∞–±–ª–æ–Ω —É–∑–ª–∞
diagram.nodeTemplate =
    $(go.Node, "Auto",
        {
            cursor: "pointer",
            doubleClick: (e, node) => {
                window.location.href = `/tasks/${node.data.key}/edit/`;
            }
        },
        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º–∞ —É–∑–ª–∞ —Å —É—Å–ª–æ–≤–Ω—ã–º–∏ —Å—Ç–∏–ª—è–º–∏
        $(go.Shape, "Rectangle", 
            { 
                fill: "#FFFFFF",  // –ë–∞–∑–æ–≤—ã–π —Ü–≤–µ—Ç —Ñ–æ–Ω–∞
                strokeWidth: 2,
                portId: ""
            },
            // –£—Å–ª–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞
            new go.Binding("fill", "is_ready", r => r ? "#E8F5E9" : "#FFFFFF"),
            new go.Binding("stroke", "status", s => {
                switch(s) {
                    case 'waiting': return '#FFEB3B';
                    case 'in_progress': return '#2196F3';
                    case 'completed': return '#4CAF50';
                    default: return '#1F4963';
                }
            })
        ),
        
        $(go.Panel, "Vertical",
            { margin: 8 },
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–¥–∞—á–∏
            $(go.TextBlock,
                {
                    font: "bold 14px Segoe UI",
                    stroke: "#1F4963",
                    margin: new go.Margin(0, 0, 4, 0),
                    wrap: go.TextBlock.WrapFit,
                    maxSize: new go.Size(200, NaN)
                },
                new go.Binding("text", "title")),
            
            // –°—Ç—Ä–æ–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∏ –¥–µ–¥–ª–∞–π–Ω–∞
            $(go.Panel, "Horizontal",
                $(go.TextBlock,
                    {
                        font: "italic 11px Segoe UI",
                        stroke: "#666",
                        margin: new go.Margin(0, 10, 0, 0)
                    },
                    new go.Binding("text", "status", s => `–°—Ç–∞—Ç—É—Å: ${s.toUpperCase()}`)),
                
                $(go.TextBlock,
                    {
                        font: "11px Segoe UI",
                        stroke: "#E91E63",
                        visible: false
                    },
                    new go.Binding("visible", "deadline", d => d !== null),
                    new go.Binding("text", "deadline", d => `üìÖ ${new Date(d).toLocaleDateString()}`))
            ),
            
            // –ü—Ä–æ–≥—Ä–µ—Å—Å –∏ —É—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞
            $(go.Panel, "Horizontal",
                { stretch: go.GraphObject.Horizontal },
                // –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
                $(go.Panel, "Horizontal",
                    { width: 80, height: 8 },
                    $(go.Shape, "Rectangle",
                        {
                            fill: "#EEE",
                            stroke: null,
                            width: 80,
                            height: 8
                        }),
                    $(go.Shape, "Rectangle",
                        {
                            fill: "#4CAF50",
                            stroke: null,
                            width: 0,
                            height: 8,
                            alignment: go.Spot.Left
                        },
                        new go.Binding("width", "progress", p => (p)*1))
                ),
                
                // –£—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞
                $(go.TextBlock,
                    {
                        font: "bold 11px Segoe UI",
                        margin: new go.Margin(0, 0, 0, 10)
                    },
                    new go.Binding("text", "risk_level", l => `–†–ò–°–ö: ${l.toUpperCase()}`),
                    new go.Binding("stroke", "risk_level", l => {
                        switch(l) {
                            case 'high': return '#F44336';
                            case 'medium': return '#FF9800';
                            default: return '#4CAF50';
                        }
                    })),
                $(go.TextBlock,
                    {
                        font: "11px Segoe UI",
                        stroke: "#666",
                        margin: new go.Margin(0, 0, 0, 5)
                    },
                    new go.Binding("text", "dependencyProgress", p => `${Math.round(p * 100)}% –≤—ã–ø–æ–ª–Ω–µ–Ω–æ`))
            ),
            ),
            
            // –ò–∫–æ–Ω–∫–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–≤–æ–π—Å—Ç–≤
            $(go.Panel, "Horizontal",
                { margin: new go.Margin(5, 0, 0, 0) },
                $(go.TextBlock,
                    {
                        font: "11px Segoe UI",
                        stroke: "#9C27B0",
                        visible: false
                    },
                    new go.Binding("visible", "is_recurring"),
                    new go.Binding("text", "is_recurring", r => r ? "üîÑ –ü–æ–≤—Ç–æ—Ä—è–µ–º–∞—è" : "")),
                
                $(go.TextBlock,
                    {
                        font: "11px Segoe UI",
                        stroke: "#3F51B5",
                        visible: false
                    },
                    new go.Binding("visible", "categories", c => c.length > 0),
                    new go.Binding("text", "categories", c => `üè∑Ô∏è ${c.join(', ')}`))
            )
        );

    diagram.linkTemplate =
        $(go.Link,
            {
                curve: go.Curve.Bezier,
                toEndSegmentLength: 30,
                fromEndSegmentLength: 30
            },
            $(go.Shape, { strokeWidth: 1.5 })
        );

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    async function loadTasks() {
        try {
            const response = await axios.get('/api/tasks/');
            const tasks = response.data;
            
            const taskMap = new Map(tasks.map(task => [task.id, task]));
            
            const nodes = [];
            const links = [];
            
            

            tasks.forEach(task => {
                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
            let completed = 0;
            if (task.dependencies && task.dependencies.length > 0) {
                task.dependencies.forEach(depId => {
                    const depTask = taskMap.get(depId);
                    if (depTask && depTask.status === 'done') completed++;
                });
            }

                nodes.push({
                    key: task.id,
                    title: task.title,
                    status: task.status,
                    priority: task.priority,
                    risk_level: task.risk_level,
                    progress: task.progress,
                    author: {
                        username: task.author?.username || '–Ω–µ —É–∫–∞–∑–∞–Ω'
                    },
                    created_at: task.created_at,
                    parent: task.parent ? task.parent.toString() : null,

                    dependencyProgress: task.dependencies.length > 0 ? completed / task.dependencies.length : 1, // 100% –µ—Å–ª–∏ –Ω–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
            
                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏:
                    is_ready: task.is_ready,
                    complexity: task.complexity,
                    start_date: task.start_date,
                    end_date: task.end_date
                });

                // –°—Ç—Ä–æ–∏–º —Å–≤—è–∑–∏ –∏–∑ dependencies
                task.dependencies.forEach(depId => {
                    links.push({
                        from: depId,
                        to: task.id
                    });
                });
            });

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º GraphLinksModel –≤–º–µ—Å—Ç–æ TreeModel
            diagram.model = new go.GraphLinksModel({
                nodeDataArray: nodes,
                linkDataArray: links
            });

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
        }
    }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–æ–º
    document.getElementById('zoomIn').addEventListener('click', () => diagram.commandHandler.increaseZoom());
    document.getElementById('zoomOut').addEventListener('click', () => diagram.commandHandler.decreaseZoom());
    document.getElementById('fit').addEventListener('click', () => diagram.commandHandler.fitToBounds());

    loadTasks();
});
</script>
{% endblock %}