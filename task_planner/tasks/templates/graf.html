{% extends 'base.html' %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h3>Граф задач</h3>
        <div class="btn-group">
            <button class="btn btn-sm btn-outline-secondary" id="zoomIn">+</button>
            <button class="btn btn-sm btn-outline-secondary" id="zoomOut">-</button>
            <button class="btn btn-sm btn-outline-primary" id="fit">Авторазмер</button>
        </div>
    </div>
    <div class="card-body">
        <div id="diagramDiv" style="width: 100%; height: 600px; background-color: #fafafa; border: 1px solid #ddd;"></div>
    </div>
</div>

<script src="https://unpkg.com/gojs/release/go.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const $ = go.GraphObject.make;
    
    // Инициализация диаграммы с TreeLayout
    const diagram = $(go.Diagram, "diagramDiv", {
        initialContentAlignment: go.Spot.Center,
        "undoManager.isEnabled": true,
        layout: $(go.TreeLayout, { 
            
            nodeSpacing: 20,
 
        })
    });

    // Шаблон узла
        diagram.nodeTemplate =
        $(go.Node, "Auto",
            {
                cursor: "pointer",
                doubleClick: (e, node) => {
                    window.location.href = `/tasks/${node.data.key}/edit/`;
                }
            },
            $(go.Shape, "Rectangle", 
                { 
                    fill: "#1F4963", 
                    stroke: null,
                    portId: ""
                }),
            $(go.Panel, "Vertical",
                $(go.TextBlock,
                    {
                        font: "bold 13px Helvetica, Arial, sans-serif",
                        stroke: "white",
                        margin: 3,
                        click: (e, obj) => {
                            window.open(`/tasks/${obj.part.data.key}/`, '_blank');
                        }
                    },
                    new go.Binding("text", "key"))
            )
        );

    diagram.linkTemplate =
        $(go.Link,
            {
                curve: go.Curve.Bezier,
                toEndSegmentLength: 30,
                fromEndSegmentLength: 30
            },
            $(go.Shape, { strokeWidth: 1.5 })
        );

    // Загрузка данных
    async function loadTasks() {
        try {
            const response = await axios.get('/api/tasks/');
            const tasks = response.data;
            
            const nodes = [];
            const links = [];
            
            

            tasks.forEach(task => {
                nodes.push({
                    key: task.id,
                    name: task.title // Убедитесь, что API возвращает title
                });

                // Строим связи из dependencies
                task.dependencies.forEach(depId => {
                    links.push({
                        from: depId,
                        to: task.id
                    });
                });
            });

            // Используем GraphLinksModel вместо TreeModel
            diagram.model = new go.GraphLinksModel({
                nodeDataArray: nodes,
                linkDataArray: links
            });

        } catch (error) {
            console.error('Ошибка загрузки данных:', error);
        }
    }

    // Управление масштабом
    document.getElementById('zoomIn').addEventListener('click', () => diagram.commandHandler.increaseZoom());
    document.getElementById('zoomOut').addEventListener('click', () => diagram.commandHandler.decreaseZoom());
    document.getElementById('fit').addEventListener('click', () => diagram.commandHandler.fitToBounds());

    loadTasks();
});
</script>
{% endblock %}