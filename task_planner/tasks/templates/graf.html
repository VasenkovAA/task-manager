{% extends 'base.html' %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h3>Граф задач</h3>
        <div class="btn-group">
            <button class="btn btn-sm btn-outline-secondary" id="zoomIn">+</button>
            <button class="btn btn-sm btn-outline-secondary" id="zoomOut">-</button>
            <button class="btn btn-sm btn-outline-primary" id="fit">Авторазмер</button>
        </div>
    </div>
    <div class="card-body">
        <div id="diagramDiv" style="width: 100%; height: 600px; background-color: #fafafa; border: 1px solid #ddd;"></div>
    </div>
</div>

<script src="https://unpkg.com/gojs/release/go.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const $ = go.GraphObject.make;
    
    // Инициализация диаграммы
    const diagram = $(go.Diagram, "diagramDiv", {
        initialContentAlignment: go.Spot.Center,
        "undoManager.isEnabled": true,
        layout: $(go.ForceDirectedLayout)
    });

    // Шаблон узла
    diagram.nodeTemplate =
        $(go.Node, "Auto",
            {
                cursor: "pointer",
                doubleClick: (e, node) => {
                    window.location.href = `/tasks/${node.data.key}/edit/`;
                }
            },
            $(go.Shape, "RoundedRectangle", 
                {
                    fill: "#fff",
                    stroke: "#4CAF50",
                    strokeWidth: 2,
                    portId: ""
                },
                new go.Binding("fill", "color"),
                new go.Binding("stroke", "borderColor")),
            $(go.Panel, "Vertical",
                { margin: 8 },
                // Заголовок
                $(go.TextBlock,
                    { 
                        font: "bold 14px Segoe UI",
                        stroke: "#333",
                        margin: new go.Margin(0, 0, 4, 0)
                    },
                    new go.Binding("text", "name")),
                
                // Статус
                $(go.TextBlock,
                    { 
                        font: "12px Segoe UI",
                        stroke: "#666",
                        margin: new go.Margin(0, 0, 2, 0)
                    },
                    new go.Binding("text", "status", s => `Статус: ${s.toUpperCase()}`)),
                
                // Прогресс
                $(go.Panel, "Horizontal",
                    { stretch: go.GraphObject.Horizontal },
                    $(go.Panel, "Horizontal",
                        { width: 60, height: 12 },
                        $(go.Shape, "Rectangle",  // Фон
                            {
                                name: "BG",
                                fill: "#e0e0e0",
                                stroke: null,
                                width: 60,
                                height: 12
                            }),
                        $(go.Shape, "Rectangle",  // Индикатор прогресса
                            {
                                name: "PROGRESS",
                                fill: "#4CAF50",
                                stroke: null,
                                width: 0,
                                height: 12,
                                alignment: go.Spot.Left
                            },
                            new go.Binding("width", "progress", p => (p/100)*60))
                    ),
                    $(go.TextBlock,
                        { 
                            font: "12px Segoe UI",
                            stroke: "#666",
                            margin: new go.Margin(0, 0, 0, 5)
                        },
                        new go.Binding("text", "progress", p => `${p}%`))
                ),
                
                // Флаг готовности
                $(go.TextBlock,
                    { 
                        font: "italic 12px Segoe UI",
                        stroke: "#2196F3",
                        visible: false
                    },
                    new go.Binding("visible", "is_ready"),
                    new go.Binding("text", "is_ready", r => r ? "Готова к выполнению ✓" : ""))
            )
        );

    // Шаблон связи
    diagram.linkTemplate =
        $(go.Link,
            { 
                routing: go.Link.AvoidsNodes,
                curve: go.Link.JumpOver,
                corner: 5
            },
            $(go.Shape, { stroke: "#999", strokeWidth: 2 }),
            $(go.Shape, { toArrow: "Standard", stroke: "#999" })
        );

    // Загрузка данных
    async function loadTasks() {
        try {
            const response = await axios.get('/api/tasks/');
            const tasks = response.data;
            
            const nodes = [];
            const links = [];
            
            tasks.forEach(task => {
                let color = "#fff";
                let borderColor = "#4CAF50";
                switch(task.status) {
                    case 'done': 
                        color = "#E8F5E9";
                        break;
                    case 'progress': 
                        color = "#FFF3E0";
                        borderColor = "#FFA726";
                        break;
                    case 'canceled': 
                        color = "#FFEBEE";
                        borderColor = "#EF5350";
                        break;
                }
                
                nodes.push({
                    key: task.id,
                    name: task.title,
                    status: task.status,
                    progress: task.progress || 0,
                    is_ready: task.is_ready,
                    color: color,
                    borderColor: borderColor
                });

                task.dependencies.forEach(depId => {
                    links.push({
                        from: depId,
                        to: task.id
                    });
                });
            });

            diagram.model = new go.GraphLinksModel(nodes, links);
        } catch (error) {
            console.error('Ошибка загрузки данных:', error);
        }
    }

    // Управление масштабом
    document.getElementById('zoomIn').addEventListener('click', () => diagram.commandHandler.increaseZoom());
    document.getElementById('zoomOut').addEventListener('click', () => diagram.commandHandler.decreaseZoom());
    document.getElementById('fit').addEventListener('click', () => diagram.commandHandler.fitToBounds());

    loadTasks();
});
</script>
{% endblock %}